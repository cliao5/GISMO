# Create inputs folder at gs://toga-human_hg38_reference/partitioned-heritability/inputs
## 1000G_EUR_Phase3_plink 
### From: gs://broad-alkesgroup-public-requester-pays/LDSCORE/1000G_Phase3_plinkfiles.tgz
### gs://toga-human_hg38_reference/partitioned-heritability/inputs/reference/1000G_EUR_Phase3_plink/

## hapmap3_snps
### From: gs://broad-alkesgroup-public-requester-pays/LDSCORE/hapmap3_snps.tgz
### gs://toga-human_hg38_reference/partitioned-heritability/inputs/reference/hapmap3_snps/
### USING THIS INSTEAD: w_hm3.snplist

## Baseline model
### From: gs://broad-alkesgroup-public-requester-pays/LDSCORE/1000G_Phase3_baselineLD_v2.2_ldscores.tgz
### gs://toga-human_hg38_reference/partitioned-heritability/inputs/reference/1000G_Phase3_baselineLD_v2.2_ldscores
### USING THIS INSTEAD: gs://toga-human_hg38_reference/partitioned-heritability/inputs/reference/1000G_Phase3_baselineLD_ldscores

## Weights
### From: gs://broad-alkesgroup-public-requester-pays/LDSCORE/1000G_Phase3_weights_hm3_no_MHC.tgz
### gs://toga-human_hg38_reference/partitioned-heritability/inputs/reference/1000G_Phase3_weights_hm3_no_MHC

## Upload frqfile
### From: gs://broad-alkesgroup-public-requester-pays/LDSCORE/1000G_Phase3_frq.tgz
### gs://toga-human_hg38_reference/partitioned-heritability/inputs/reference/1000G_Phase3_frq


## Upload gene sets (gene-coord and gene-set files) of decile and random deciles
### Download most recent gencode.v44 from https://www.gencodegenes.org/human/





### Generate gene-coord and gene-set files (locally)
Rscript 00_GISMO-mis_gencode-v24_annotate-ensembl.R
gsutil -m cp -r inputs/decile gs://toga-human_hg38_reference/partitioned-heritability/inputs/GISMO/
gsutil -m cp -r inputs/decile_rand gs://toga-human_hg38_reference/partitioned-heritability/inputs/GISMO/
gsutil -m cp -r inputs/decile-list gs://toga-human_hg38_reference/partitioned-heritability/inputs/GISMO/




# The rest of the computation happens on a VM
### Start VM (e2-standard-16 for now)
### Send up script to run
gcloud compute scp --zone "us-central1-b" scripts/01_ldsc-run.sh rye@rye-gismo-mis:/home/rye/partitioned-heritability/scripts/
### Connect to VM

# Set up
sudo apt-get update
sudo apt-get install git # git
sudo apt-get install python3-pip # pip
sudo apt-get install parallel # parallel

## Conda
wget https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh
bash Miniconda3-latest-Linux-x86_64.sh
rm Miniconda3-latest-Linux-x86_64.sh
source .bashrc
conda activate

## ldsc
git clone https://github.com/bulik/ldsc.git
cd ldsc; conda env create --file environment.yml;
conda activate ldsc; ./ldsc.py -h; ./munge_sumstats.py -h; conda deactivate

## gcsfuse
export GCSFUSE_REPO=gcsfuse-`lsb_release -c -s`
echo "deb https://packages.cloud.google.com/apt $GCSFUSE_REPO main" | sudo tee /etc/apt/sources.list.d/gcsfuse.list
curl https://packages.cloud.google.com/apt/doc/apt-key.gpg | sudo apt-key add -
sudo apt-get update
sudo apt-get install fuse gcsfuse

## Mount bucket
MOUNT=/home/rye/toga-human_hg38_reference/
mkdir -p "${MOUNT}"
gcsfuse --implicit-dirs toga-human_hg38_reference "${MOUNT}"


# Run ldsc for deciles and random deciles
screen
BUCKET=/home/rye/toga-human_hg38_reference/partitioned-heritability
./01_ldsc-run.sh "${BUCKET}"/inputs "${BUCKET}"/inputs/GISMO/decile-list GISMO/decile /home/rye/partitioned-heritability/outputs
BUCKET=/home/rye/toga-human_hg38_reference/partitioned-heritability
./01_ldsc-run.sh "${BUCKET}"/inputs "${BUCKET}"/inputs/GISMO/decile-list GISMO/decile_rand /home/rye/partitioned-heritability/outputs



# Copy outputs to bucket
# gcloud auth login
gsutil -m cp -r /home/rye/partitioned-heritability/outputs/GISMO/decile/d* gs://toga-human_hg38_reference/partitioned-heritability/outputs/GISMO/decile/
gsutil -m cp -r /home/rye/partitioned-heritability/outputs/GISMO/decile_rand/d* gs://toga-human_hg38_reference/partitioned-heritability/outputs/GISMO/decile_rand/

# Detach bucket
# gcloud auth revoke rye@broadinstitute.org
fusermount -u "${MOUNT}"


# All traits
## Send scripts up
gcloud compute scp --zone "us-central1-b" 04_gwas-run.sh rye@rye-gismo-mis:/home/rye/partitioned-heritability/scripts/

## Decile
for i in {1..11}; do
    BUCKET=/home/rye/toga-human_hg38_reference/partitioned-heritability
    ./04_gwas-run.sh /home/rye/partitioned-heritability/outputs "${BUCKET}"/inputs/GISMO/decile-list GISMO/decile /home/rye/partitioned-heritability/outputs "${BUCKET}"/inputs/sumstats/ukb31063_ldsc/traits-list_"${i}" traits-list_"${i}"
done
gsutil -m cp -r /home/rye/partitioned-heritability/outputs/GISMO/decile/GWAS/ gs://toga-human_hg38_reference/partitioned-heritability/outputs/GISMO/decile

## Decile_rand
for i in {1..11}; do
    BUCKET=/home/rye/toga-human_hg38_reference/partitioned-heritability
    ./04_gwas-run.sh /home/rye/partitioned-heritability/outputs "${BUCKET}"/inputs/GISMO/decile-list GISMO/decile_rand /home/rye/partitioned-heritability/outputs "${BUCKET}"/inputs/sumstats/ukb31063_ldsc/traits-list_"${i}" traits-list_"${i}"
done
gsutil -m cp -r /home/rye/partitioned-heritability/outputs/GISMO/decile_rand/GWAS/ gs://toga-human_hg38_reference/partitioned-heritability/outputs/GISMO/decile_rand


## Merge results locally
python3  /Users/rye/Projects/GISMO/partitioned-heritability/scripts/05_part-herit_merge.py \
    --indir gs://toga-human_hg38_reference/partitioned-heritability/outputs/GISMO/decile/GWAS \
    --traits gs://toga-human_hg38_reference/partitioned-heritability/inputs/sumstats/ukb31063_ldsc/gnomAD-LoF_650sumstats.tsv \
    --groups gs://toga-human_hg38_reference/partitioned-heritability/inputs/GISMO/decile-list \
    --out gs://toga-human_hg38_reference/partitioned-heritability/outputs/GISMO/decile/GWAS/merged_result.tsv > 05_part-herit_merge.log
### Pull down
gsutil cp gs://toga-human_hg38_reference/partitioned-heritability/outputs/GISMO/decile/GWAS/merged_result.tsv .